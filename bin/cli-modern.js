"use strict";var path=require("path"),os=require("os"),spawn=require("child_process").spawn,blessed=require("blessed"),clear=require("clear"),fse=require("fs-extra"),version=require("../package.json").version,defaultConfigFilePath=path.resolve(os.homedir(),"myterminal-configs.json");module.exports=function(){var e,t,n,o,r={},c=[";",".","/","q","C-c","C-q"],s=[],i=function(){r.screen=blessed.screen({smartCSR:!0,title:"myterminal-cli v"+version,dockBorders:!0}),r.menuBox=blessed.box({parent:r.screen,left:0,top:0,width:"100%",height:"100%",tags:!0,style:{bg:"#111"}}),r.menuBoxTitle=blessed.text({parent:r.menuBox,left:0,top:0,width:"100%",height:"shrink",content:"myterminal-cli v"+version,tags:!0,align:"center",padding:1,style:{fg:"black",bg:"#00FFFF"}}),r.menuBoxThreader=blessed.text({parent:r.menuBox,left:0,top:3,width:"100%",height:"shrink",content:"All",tags:!0,padding:1,style:{bg:"#111"}}),r.menuBoxInstructions=blessed.text({parent:r.menuBox,left:0,top:6,width:"100%",height:"shrink",content:"Press a marked key to perform the respective operation",tags:!0,style:{bg:"#111"}}),r.menuBoxTable=blessed.text({parent:r.menuBox,left:0,top:7,width:"100%",height:"shrink",content:"{red-fg}(q){/} Quit",tags:!0,padding:1,style:{bg:"#111"}}),r.commandLogBox=blessed.box({parent:r.screen,left:"50%-1",top:0,width:"50%+1",height:"100%",border:{type:"bg",top:!1,right:!1,bottom:!1,left:!0},hidden:!0,scrollable:!0,alwaysScroll:!0,tags:!0,style:{border:{fg:"#339933"}}}),r.commandLogBoxTitle=blessed.text({parent:r.commandLogBox,left:0,top:0,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{bg:"green"}}),r.commandLogBoxSubtitle=blessed.text({parent:r.commandLogBox,left:0,top:1,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{fg:"black",bg:"white"}}),r.prompt=blessed.prompt({parent:r.screen,border:"line",height:"shrink",width:"half",top:"center",left:"center",label:" {blue-fg}Enter the value for{/blue-fg} ",tags:!0,keys:!0,vi:!0})},a=function(){l(),p()},l=function(){m(),d(),r.screen.render()},m=function(){var t=s.map(function(e,t){return s.slice(0,t+1)}).map(function(t,n){return t.reduce(function(e,t){return e.commands[t]},e)}).map(function(e){return e.title}),n=[e.title].concat(t).map(function(e){return"{#00FFFF-fg}"+e+"{/}"}).join(" -> ");r.menuBoxThreader.setContent(n)},d=function(){var o=f(),c=[];h().forEach(function(e){return c.push("{green-fg}("+e+"){/} "+o.commands[e].title+(o.commands[e].commands?"...":""))}),c.push(""),t&&c.push("{green-fg}(;){/} Select the last action"),n&&c.push("{green-fg}(.){/} Re-run the last command"),c.push("{green-fg}(/){/} Run a custom command"),c.push(""),o!==e?c.push("{red-fg}(q){/} Go back..."):c.push("{red-fg}(q){/} Quit"),r.menuBoxTable.setContent(c.join("\n"))},u=function(e){r.commandLogBox.setContent(""),r.commandLogBoxTitle.setContent("{green-bg}Command: "+(e.title||e.task)+"{/}"),r.commandLogBoxTitle.show(),r.commandLogBoxSubtitle.setContent("{white-bg}Directory: "+k(e.directory)+"{/}"),r.commandLogBoxSubtitle.show(),r.commandLogBox.insertBottom(""),r.commandLogBox.insertBottom(""),r.screen.render()},g=function(){r.menuBoxTable.insertBottom("\nYou can press {yellow-fg}(\\){/} to abort current task")},f=function(){return s.length?s.reduce(function(e,t){return e.commands[t]},e):e},h=function(){return Object.keys(f().commands)},p=function(){h().concat(c).forEach(function(e){return r.screen.key(e,b)})},x=function(){process.on("SIGINT",function(){o?S():process.exit()})},b=function(o){if(h().concat(c).forEach(function(e){return r.screen.unkey(e)}),"C-c"===o||"C-q"===o)q();else if("/"===o)l(),g(),w();else if(";"===o)t?(l(),g(),L(t)):a();else if("."===o)n?(l(),g(),u(n),v(n.task,n.directory)):a();else if("q"===o)s.length||q(),s.pop(),a();else if(h().indexOf(o)>-1){var i=function(t){return s.length?s.reduce(function(e,t){return e.commands[t]},e).commands[t]:e.commands[t]}(o);i.task?(l(),g(),L(i)):(s.push(o),a())}else a()},B=function(e){r.commandLogBox.insertBottom("{magenta-bg}Aborted{/}"),r.commandLogBox.setScrollPerc(100),S()},y=function e(t,n,o){t.length===n.length?o(t):r.prompt.input(n[t.length],"",function(c,s){try{e(t.concat([s]),n,o)}catch(e){r.commandLogBox.insertBottom("{red-bg}"+e.toString()+"{/}"),r.commandLogBox.setScrollPerc(100),a()}})},k=function(e){return e||f().directory||"."},L=function(e){t=e,r.menuBox.width="50%",r.commandLogBox.show(),u(e),e.params?function(e){y([],e.params,function(t){var n=[e.task].concat(t).join(" ");v(n,e.directory)})}(e):v(e.task,e.directory)},w=function(){y([],["custom-command","directory"],function(e){var t=k(e[1]);L({title:e[0],task:e[0],directory:t})})},v=function(e,t){var c=e.split(" "),s=c[0],i=c.slice(1),a=k(t);n={task:e,directory:a},(o=spawn(s,i,{cwd:a,shell:!0})).stdout.on("data",function(e){r.commandLogBox.insertBottom(e.toString()),r.commandLogBox.setScrollPerc(100),r.screen.render()}),o.stderr.on("data",function(e){r.commandLogBox.insertBottom("{red-bg}Error{/}"),r.commandLogBox.insertBottom("{red-fg}"+e.toString()+"{/}"),r.commandLogBox.setScrollPerc(100),r.screen.render()}),o.on("close",C),r.screen.key("\\",B)},S=function(){o.kill(),o=null},C=function(){r.commandLogBox.insertBottom("{green-bg}Done{/}"),r.commandLogBox.setScrollPerc(100),r.screen.render(),l(),o=null,r.screen.unkey("\\"),p()},q=function(){r.screen.destroy(),clear()};return{copyConfigFileIfNotPresent:function(){fse.copySync(path.resolve(__dirname,"../examples/configs.json"),defaultConfigFilePath,{overwrite:!1})},setConfigs:function(t){e=t},init:function(){x(),i(),r.screen.enableKeys(),a()}}}();