var path=require("path"),os=require("os"),spawn=require("child_process").spawn,blessed=require("blessed"),clear=require("clear"),fse=require("fs-extra"),version=require("../package.json").version,defaultConfigFilePath=path.resolve(os.homedir(),"myterminal-configs.json");module.exports=function(){var e={};e.screen=blessed.screen({smartCSR:!0,title:"myterminal-cli v"+version,dockBorders:!0}),e.menuBox=blessed.box({parent:e.screen,left:0,top:0,width:"100%",height:"100%",tags:!0,style:{bg:"#111"}}),e.menuBoxTitle=blessed.text({parent:e.menuBox,left:0,top:0,width:"100%",height:"shrink",content:"myterminal-cli v"+version,tags:!0,align:"center",padding:1,style:{fg:"black",bg:"#00FFFF"}}),e.menuBoxThreader=blessed.text({parent:e.menuBox,left:0,top:3,width:"100%",height:"shrink",content:"All",tags:!0,padding:1,style:{bg:"#111"}}),e.menuBoxInstructions=blessed.text({parent:e.menuBox,left:0,top:6,width:"100%",height:"shrink",content:"Press a marked key to perform the respective operation",tags:!0,style:{bg:"#111"}}),e.menuBoxTable=blessed.text({parent:e.menuBox,left:0,top:7,width:"100%",height:"shrink",content:"{red-fg}(q){/} Quit",tags:!0,padding:1,style:{bg:"#111"}}),e.commandLogBox=blessed.box({parent:e.screen,left:"50%-1",top:0,width:"50%+1",height:"100%",border:{type:"bg",top:!1,right:!1,bottom:!1,left:!0},hidden:!0,scrollable:!0,alwaysScroll:!0,tags:!0,style:{border:{fg:"#339933"}}}),e.commandLogBoxTitle=blessed.text({parent:e.commandLogBox,left:0,top:0,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{bg:"green"}}),e.commandLogBoxSubtitle=blessed.text({parent:e.commandLogBox,left:0,top:1,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{fg:"black",bg:"white"}}),e.prompt=blessed.prompt({parent:e.screen,border:"line",height:"shrink",width:"half",top:"center",left:"center",label:" {blue-fg}Enter the value for{/blue-fg} ",tags:!0,keys:!0,vi:!0});var t,n,o,r,c=[";",".","/","q","C-c","C-q"],s=[],i=function(){l(),b()},a=function(){e.commandLogBox.setContent("")},l=function(){m(),d(),e.screen.render()},m=function(){var n=s.map(function(e,t){return s.slice(0,t+1)}).map(function(e,n){return e.reduce(function(e,t){return e.commands[t]},t)}).map(function(e){return e.title}),o=[t.title].concat(n).map(function(e){return"{#00FFFF-fg}"+e+"{/}"}).join(" -> ");e.menuBoxThreader.setContent(o)},d=function(){var r=h(),c=[];p().forEach(function(e){c.push("{green-fg}("+e+"){/} "+r.commands[e].title+(r.commands[e].commands?"...":""))}),c.push(""),n&&c.push("{green-fg}(;){/} Select the last action"),o&&c.push("{green-fg}(.){/} Re-run the last command"),c.push("{green-fg}(/){/} Run a custom command"),c.push(""),r!==t?c.push("{red-fg}(q){/} Go back..."):c.push("{red-fg}(q){/} Quit"),e.menuBoxTable.setContent(c.join("\n"))},u=function(t){a(),e.commandLogBoxTitle.setContent("{green-bg}Command: "+(t.title||t.task)+"{/}"),e.commandLogBoxTitle.show(),e.commandLogBoxSubtitle.setContent("{white-bg}Directory: "+C(t.directory)+"{/}"),e.commandLogBoxSubtitle.show(),e.commandLogBox.insertBottom(""),e.commandLogBox.insertBottom(""),e.screen.render()},g=function(){e.commandLogBox.insertBottom("{green-bg}Done{/}"),e.commandLogBox.setScrollPerc(100),e.screen.render()},f=function(){e.menuBoxTable.insertBottom("\nYou can press {yellow-fg}(\\){/} to abort current task")},h=function(){return s.length?s.reduce(function(e,t){return e.commands[t]},t):t},p=function(){return Object.keys(h().commands)},x=function(e){return s.length?s.reduce(function(e,t){return e.commands[t]},t).commands[e]:t.commands[e]},b=function(){p().concat(c).forEach(function(t){e.screen.key(t,L)})},B=function(){p().concat(c).forEach(function(t){e.screen.unkey(t)})},y=function(){e.screen.key("\\",w)},k=function(){e.screen.unkey("\\")},L=function(e){if(B(),"C-c"===e||"C-q"===e)E();else if("/"===e)l(),f(),F();else if(";"===e)n?(l(),f(),q(n)):i();else if("."===e)o?(l(),f(),u(o),T(o.task,o.directory)):i();else if("q"===e)s.length||E(),s.pop(),i();else if(p().indexOf(e)>-1){var t=x(e);t.task?(l(),f(),q(t)):(s.push(e),i())}else i()},w=function(t){e.commandLogBox.insertBottom("{magenta-bg}Aborted{/}"),e.commandLogBox.setScrollPerc(100),P()},v=function(e){S([],e.params,function(t){var n=[e.task].concat(t).join(" ");T(n,e.directory)})},S=function(t,n,o){t.length===n.length?o(t):e.prompt.input(n[t.length],"",function(r,c){try{S(t.concat([c]),n,o)}catch(t){e.commandLogBox.insertBottom("{red-bg}"+t.toString()+"{/}"),e.commandLogBox.setScrollPerc(100),i()}})},C=function(e){return e||h().directory||"."},q=function(t){n=t,e.menuBox.width="50%",e.commandLogBox.show(),u(t),t.params?v(t):T(t.task,t.directory)},F=function(){S([],["custom-command","directory"],function(e){var t=C(e[1]);q({title:e[0],task:e[0],directory:t})})},T=function(t,n){var c=t.split(" "),s=c[0],i=c.slice(1),a=C(n);o={task:t,directory:a},(r=spawn(s,i,{cwd:a,shell:!0})).stdout.on("data",function(t){e.commandLogBox.insertBottom(t.toString()),e.commandLogBox.setScrollPerc(100),e.screen.render()}),r.stderr.on("data",function(t){e.commandLogBox.insertBottom("{red-bg}Error{/}"),e.commandLogBox.insertBottom("{red-fg}"+t.toString()+"{/}"),e.commandLogBox.setScrollPerc(100),e.screen.render()}),r.on("close",j),y()},P=function(){r.kill(),r=null},j=function(){g(),l(),r=null,k(),b()},E=function(){e.screen.destroy(),clear()};return process.on("SIGINT",function(){r?P():process.exit()}),e.screen.enableKeys(),{copyConfigFileIfNotPresent:function(){fse.copySync(path.resolve(__dirname,"../examples/configs.json"),defaultConfigFilePath,{overwrite:!1})},setConfigs:function(e){t=e},promptForAction:i}}();