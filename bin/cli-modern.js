"use strict";var _require=require("child_process"),spawn=_require.spawn,blessed=require("blessed"),clear=require("clear"),_require2=require("../package.json"),version=_require2.version,configs=void 0,mostRecentlyRunCommand=void 0,lastRunShellCommand=void 0,currentCommandInstance=void 0,uiControls={},specialKeys=[";",".","/","q","C-c","C-q"],currentState=[],bindEventForAbortingCurrentCommandOnWindows=function(){process.on("SIGINT",function(){currentCommandInstance?abortCurrentShellCommand():process.exit()})},drawControls=function(){uiControls.screen=blessed.screen({smartCSR:!0,title:"myterminal-cli v"+version,dockBorders:!0}),uiControls.menuBox=blessed.box({parent:uiControls.screen,left:0,top:0,width:"100%",height:"100%",tags:!0,style:{bg:"#111"}}),uiControls.menuBoxTitle=blessed.text({parent:uiControls.menuBox,left:0,top:0,width:"100%",height:"shrink",content:"myterminal-cli v"+version,tags:!0,align:"center",padding:1,style:{fg:"black",bg:"#00FFFF"}}),uiControls.menuBoxThreader=blessed.text({parent:uiControls.menuBox,left:0,top:3,width:"100%",height:"shrink",content:"All",tags:!0,padding:1,style:{bg:"#111"}}),uiControls.menuBoxInstructions=blessed.text({parent:uiControls.menuBox,left:0,top:6,width:"100%",height:"shrink",content:"Press a marked key to perform the respective operation",tags:!0,style:{bg:"#111"}}),uiControls.menuBoxTable=blessed.text({parent:uiControls.menuBox,left:0,top:7,width:"100%",height:"shrink",content:"{red-fg}(q){/} Quit",tags:!0,padding:1,style:{bg:"#111"}}),uiControls.commandLogBox=blessed.box({parent:uiControls.screen,left:"50%-1",top:0,width:"50%+1",height:"100%",border:{type:"bg",top:!1,right:!1,bottom:!1,left:!0},hidden:!0,scrollable:!0,alwaysScroll:!0,tags:!0,style:{border:{fg:"#339933"}}}),uiControls.commandLogBoxTitle=blessed.text({parent:uiControls.commandLogBox,left:0,top:0,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{bg:"green"}}),uiControls.commandLogBoxSubtitle=blessed.text({parent:uiControls.commandLogBox,left:0,top:1,width:"100%",height:"shrink",content:"",tags:!0,hidden:!0,align:"center",style:{fg:"black",bg:"white"}}),uiControls.prompt=blessed.prompt({parent:uiControls.screen,border:"line",height:"shrink",width:"half",top:"center",left:"center",label:" {blue-fg}Enter the value for{/blue-fg} ",tags:!0,keys:!0,vi:!0})},updateThreaderText=function(){var n=currentState.map(function(n,t){return currentState.slice(0,t+1)}).map(function(n){return n.reduce(function(n,t){return n.commands[t]},configs)}).map(function(n){return n.title}),t=[configs.title].concat(n).map(function(n){return"{#00FFFF-fg}"+n+"{/}"}).join(" -> ");uiControls.menuBoxThreader.setContent(t)},getCurrentCommandBranch=function(){return currentState.length?currentState.reduce(function(n,t){return n.commands[t]},configs):configs},getCurrentCommandOptions=function(){return Object.keys(getCurrentCommandBranch().commands)},updateMenuOptions=function(){var t=getCurrentCommandBranch(),e=[];getCurrentCommandOptions().forEach(function(n){e.push("{green-fg}("+n+"){/} "+t.commands[n].title+(t.commands[n].commands?"...":""))}),e.push(""),mostRecentlyRunCommand&&e.push("{green-fg}(;){/} Select the last action"),lastRunShellCommand&&e.push("{green-fg}(.){/} Re-run the last command"),e.push("{green-fg}(/){/} Run a custom command"),e.push(""),t!==configs?e.push("{red-fg}(q){/} Go back..."):e.push("{red-fg}(q){/} Quit"),uiControls.menuBoxTable.setContent(e.join("\n"))},rePrintMenu=function(){updateThreaderText(),updateMenuOptions(),uiControls.screen.render()},unbindKeyStrokesToNavigate=function(){getCurrentCommandOptions().concat(specialKeys).forEach(function(n){return uiControls.screen.unkey(n)})},exit=function(){uiControls.screen.destroy(),clear()},printCommandAbortInstructions=function(){uiControls.menuBoxTable.insertBottom("\nYou can press {yellow-fg}(\\){/} to abort current task")},promptForAction=function(){rePrintMenu(),bindKeyStrokesToNavigate()},promptUserForParametersAndExecuteCommand=function e(o,r,i){o.length===r.length?i(o):uiControls.prompt.input(r[o.length],"",function(n,t){try{e(o.concat([t]),r,i)}catch(n){uiControls.commandLogBox.insertBottom("{red-bg}"+n.toString()+"{/}"),uiControls.commandLogBox.setScrollPerc(100),promptForAction()}})},clearLog=function(){uiControls.commandLogBox.setContent("")},printCommandLogHeader=function(n){clearLog(),uiControls.commandLogBoxTitle.setContent("{green-bg}Command: "+(n.title||n.task)+"{/}"),uiControls.commandLogBoxTitle.show(),uiControls.commandLogBoxSubtitle.setContent("{white-bg}Directory: "+getSpecificCommandDirectory(n.directory)+"{/}"),uiControls.commandLogBoxSubtitle.show(),uiControls.commandLogBox.insertBottom(""),uiControls.commandLogBox.insertBottom(""),uiControls.screen.render()},getSpecificCommandDirectory=function(n){return n||getCurrentCommandBranch().directory||"."},printCommandLogFooter=function(){uiControls.commandLogBox.insertBottom("{green-bg}Done{/}"),uiControls.commandLogBox.setScrollPerc(100),uiControls.screen.render()},unbindKeyStrokesToQuitCurrentCommand=function(){uiControls.screen.unkey("\\")},finishUpWithCurrentCommand=function(){printCommandLogFooter(),rePrintMenu(),currentCommandInstance=null,unbindKeyStrokesToQuitCurrentCommand(),bindKeyStrokesToNavigate()},abortCurrentShellCommand=function(){currentCommandInstance.kill(),currentCommandInstance=null},keyStrokeHandlerForQuittingCurrentCommand=function(){uiControls.commandLogBox.insertBottom("{magenta-bg}Aborted{/}"),uiControls.commandLogBox.setScrollPerc(100),abortCurrentShellCommand()},bindKeyStrokesToQuitCurrentCommand=function(){uiControls.screen.key("\\",keyStrokeHandlerForQuittingCurrentCommand)},executeShellCommand=function(n,t){var e=n.split(" "),o=e[0],r=e.slice(1),i=getSpecificCommandDirectory(t);lastRunShellCommand={task:n,directory:i},(currentCommandInstance=spawn(o,r,{cwd:i,shell:!0})).stdout.on("data",function(n){uiControls.commandLogBox.insertBottom(n.toString()),uiControls.commandLogBox.setScrollPerc(100),uiControls.screen.render()}),currentCommandInstance.stderr.on("data",function(n){uiControls.commandLogBox.insertBottom("{red-bg}Error{/}"),uiControls.commandLogBox.insertBottom("{red-fg}"+n.toString()+"{/}"),uiControls.commandLogBox.setScrollPerc(100),uiControls.screen.render()}),currentCommandInstance.on("close",finishUpWithCurrentCommand),bindKeyStrokesToQuitCurrentCommand()},gatherParamsAndExecuteCommand=function(e){promptUserForParametersAndExecuteCommand([],e.params,function(n){var t=[e.task].concat(n).join(" ");executeShellCommand(t,e.directory)})},prepareToExecuteCommandObject=function(n){mostRecentlyRunCommand=n,uiControls.menuBox.width="50%",uiControls.commandLogBox.show(),printCommandLogHeader(n),n.params?gatherParamsAndExecuteCommand(n):executeShellCommand(n.task,n.directory)},promptForCustomCommandAndExecute=function(){promptUserForParametersAndExecuteCommand([],["custom-command","directory"],function(n){var t=getSpecificCommandDirectory(n[1]);prepareToExecuteCommandObject({title:n[0],task:n[0],directory:t})})},getCommandForOption=function(n){return currentState.length?currentState.reduce(function(n,t){return n.commands[t]},configs).commands[n]:configs.commands[n]},keyStrokeHandlerForNavigation=function(n){if(unbindKeyStrokesToNavigate(),"C-c"===n||"C-q"===n)exit();else if("/"===n)rePrintMenu(),printCommandAbortInstructions(),promptForCustomCommandAndExecute();else if(";"===n)mostRecentlyRunCommand?(rePrintMenu(),printCommandAbortInstructions(),prepareToExecuteCommandObject(mostRecentlyRunCommand)):promptForAction();else if("."===n)lastRunShellCommand?(rePrintMenu(),printCommandAbortInstructions(),printCommandLogHeader(lastRunShellCommand),executeShellCommand(lastRunShellCommand.task,lastRunShellCommand.directory)):promptForAction();else if("q"===n)currentState.length||exit(),currentState.pop(),promptForAction();else if(-1<getCurrentCommandOptions().indexOf(n)){var t=getCommandForOption(n);t.task?(rePrintMenu(),printCommandAbortInstructions(),prepareToExecuteCommandObject(t)):(currentState.push(n),promptForAction())}else promptForAction()},bindKeyStrokesToNavigate=function(){getCurrentCommandOptions().concat(specialKeys).forEach(function(n){return uiControls.screen.key(n,keyStrokeHandlerForNavigation)})};module.exports.init=function(){bindEventForAbortingCurrentCommandOnWindows(),drawControls(),uiControls.screen.enableKeys(),promptForAction()},module.exports.setConfigs=function(n){configs=n};