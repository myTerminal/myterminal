"use strict";var _require=require("child_process"),spawn=_require.spawn,_process=process,stdin=_process.stdin,prompt=require("prompt"),chalk=require("chalk"),clear=require("clear"),_require2=require("../package.json"),version=_require2.version;module.exports=function(){function o(n){console.log(chalk.inverse.green(p("Command: "+(n.title||n.task)))),console.log(chalk.inverse.white(p("Directory: "+x(n.directory)))),d()}function t(){console.log("You can press ^-C to abort current task\n")}var r,c,i,s,a=[],l=function(){u(),y()},u=function(){clear(),n(),e(),m(),f()},n=function(){var n=p("myterminal-cli v"+version);console.log(chalk.inverse.cyan(g(" "))),console.log(chalk.inverse.cyan(n)),console.log(chalk.inverse.cyan(g(" "))+"\n")},e=function(){var n=a.map(function(n,e){return a.slice(0,e+1)}).map(function(n){return n.reduce(function(n,e){return n.commands[e]},r)}).map(function(n){return n.title});console.log(chalk.cyan([r.title].concat(n).join(" -> ")+"'\n'"))},m=function(){console.log("Press a marked key to perform the respective operation\n")},f=function(){var e=k();v().forEach(function(n){console.log(chalk.green("("+n+") "+e.commands[n].title)+(e.commands[n].commands?"...":""))}),d(),c&&console.log(chalk.green("(;) ")+"Select the last action"),i&&console.log(chalk.green("(.) ")+"Re-run the last command"),console.log(chalk.green("(/) ")+"Run a custom command"),e!==r?console.log(chalk.red("\n(q) ")+"Go back...\n"):console.log(chalk.red("\n(q) ")+"Quit\n")},d=function(){console.log("")},p=function(n){var e=g(" ").length-n.length;return h(" ",Math.floor(e/2))+n+h(" ",Math.ceil(e/2))},g=function(n){return new Array(process.stdout.columns-1).join(",").split(",").map(function(){return n}).join("")},h=function(n,e){return new Array(e).join(",").split(",").map(function(){return n}).join("")},k=function(){return a.length?a.reduce(function(n,e){return n.commands[e]},r):r},v=function(){return Object.keys(k().commands)},y=function(){q(),stdin.on("data",w)},q=function(){stdin.setRawMode(!0),stdin.resume(),stdin.setEncoding("utf8")},j=function(){process.on("SIGINT",function(){s?R():process.exit()})},w=function(n){if(stdin.removeListener("data",w),""===n)E();else if("/"===n)u(),t(),C();else if(";"===n)c?(u(),t(),b(c)):l();else if("."===n)i?(u(),t(),o(i),M(i.task,i.directory)):l();else if("q"===n)a.length||E(),a.pop(),l();else if(-1<v().indexOf(n)){var e=function(n){return a.length?a.reduce(function(n,e){return n.commands[e]},r).commands[n]:r.commands[n]}(n);e.task?(u(),t(),b(e)):(a.push(n),l())}else l()},_=function(n){""===n&&R()},x=function(n){return n||k().directory||"."},b=function(n){o(c=n),n.params?function(t){prompt.start(),prompt.get(t.params,function(n,o){try{var e=[t.task].concat(t.params.map(function(n,e){return o[t.params[e]]})).join(" ");M(e,t.directory)}catch(n){l()}})}(n):M(n.task,n.directory)},C=function(){prompt.start(),prompt.get(["custom-command","directory"],function(n,e){try{var o=x(e.directory);d(),b({title:e["custom-command"],task:e["custom-command"],directory:o})}catch(n){l()}})},M=function(n,e){var o=n.split(" "),t=o[0],r=o.slice(1),c=x(e);i={task:n,directory:c},(s=spawn(t,r,{cwd:c,stdio:[0,1,2],shell:!0})).on("close",A),q(),stdin.on("data",_)},R=function(){s.kill(),s=null},A=function(){console.log("\n"+chalk.green(g("-"))),s=null,stdin.removeListener("data",_),y()},E=function(){clear(),process.exit()};return{setConfigs:function(n){r=n},init:function(){j(),l()}}}();