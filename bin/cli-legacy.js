"use strict";var path=require("path"),os=require("os"),spawn=require("child_process").spawn,stdin=process.stdin,prompt=require("prompt"),chalk=require("chalk"),clear=require("clear"),fse=require("fs-extra"),version=require("../package.json").version,defaultConfigFilePath=path.resolve(os.homedir(),"myterminal-configs.json");module.exports=function(){var n,e,o,t,r=[],c=function(){i(),q()},i=function(){clear(),s(),a(),l(),u()},s=function(){var n=p("myterminal-cli v"+version);console.log(chalk.inverse.cyan(h(" "))),console.log(chalk.inverse.cyan(n)),console.log(chalk.inverse.cyan(h(" "))+"\n")},a=function(){var e=r.map(function(n,e){return r.slice(0,e+1)}).map(function(e,o){return e.reduce(function(n,e){return n.commands[e]},n)}).map(function(n){return n.title});console.log(chalk.cyan([n.title].concat(e).join(" -> ")+"\n"))},l=function(){console.log("Press a marked key to perform the respective operation\n")},u=function(){var t=k();v().forEach(function(n){return console.log(chalk.green("("+n+") ")+t.commands[n].title+(t.commands[n].commands?"...":""))}),d(),e&&console.log(chalk.green("(;) ")+"Select the last action"),o&&console.log(chalk.green("(.) ")+"Re-run the last command"),console.log(chalk.green("(/) ")+"Run a custom command"),t!==n?console.log(chalk.red("\n(q) ")+"Go back...\n"):console.log(chalk.red("\n(q) ")+"Quit\n")},f=function(n){console.log(chalk.inverse.green(p("Command: "+(n.title||n.task)))),console.log(chalk.inverse.white(p("Directory: "+A(n.directory)))),d()},m=function(){console.log("You can press ^-C to abort current task\n")},d=function(){console.log("")},p=function(n){var e=h(" ").length-n.length;return g(" ",Math.floor(e/2))+n+g(" ",Math.ceil(e/2))},h=function(n){return new Array(process.stdout.columns-1).join(",").split(",").map(function(){return n}).join("")},g=function(n,e){return new Array(e).join(",").split(",").map(function(){return n}).join("")},k=function(){return r.length?r.reduce(function(n,e){return n.commands[e]},n):n},v=function(){return Object.keys(k().commands)},y=function(e){return r.length?r.reduce(function(n,e){return n.commands[e]},n).commands[e]:n.commands[e]},q=function(){C(),stdin.on("data",F)},j=function(){stdin.removeListener("data",F)},w=function(){C(),stdin.on("data",P)},x=function(){stdin.removeListener("data",P)},C=function(){stdin.setRawMode(!0),stdin.resume(),stdin.setEncoding("utf8")},F=function(n){if(j(),""===n)E();else if("/"===n)i(),m(),M();else if(";"===n)e?(i(),m(),I(e)):c();else if("."===n)o?(i(),m(),f(o),R(o.task,o.directory)):c();else if("q"===n)r.length||E(),r.pop(),c();else if(v().indexOf(n)>-1){var t=y(n);t.task?(i(),m(),I(t)):(r.push(n),c())}else c()},P=function(n){""===n&&S()},b=function(n){prompt.start(),prompt.get(n.params,function(e,o){try{var t=[n.task].concat(n.params.map(function(e,t){return o[n.params[t]]})).join(" ");R(t,n.directory)}catch(n){c()}})},A=function(n){return n||k().directory||"."},I=function(n){e=n,f(n),n.params?b(n):R(n.task,n.directory)},M=function(){prompt.start(),prompt.get(["custom-command","directory"],function(n,e){try{var o=A(e.directory);d(),I({title:e["custom-command"],task:e["custom-command"],directory:o})}catch(n){c()}})},R=function(n,e){var r=n.split(" "),c=r[0],i=r.slice(1),s=A(e);o={task:n,directory:s},(t=spawn(c,i,{cwd:s,stdio:[0,1,2],shell:!0})).on("close",_),w()},S=function(){t.kill(),t=null},_=function(){console.log("\n"+chalk.green(h("-"))),t=null,x(),q()},E=function(){clear(),process.exit()};return process.on("SIGINT",function(){t?S():process.exit()}),{copyConfigFileIfNotPresent:function(){fse.copySync(path.resolve(__dirname,"../examples/configs.json"),defaultConfigFilePath,{overwrite:!1})},setConfigs:function(e){n=e},promptForAction:c}}();