var path=require("path"),os=require("os"),spawn=require("child_process").spawn,stdin=process.stdin,prompt=require("prompt"),chalk=require("chalk"),clear=require("clear"),fse=require("fs-extra"),version=require("../package.json").version,defaultConfigFilePath=path.resolve(os.homedir(),"myterminal-configs.json");module.exports=function(){var n,o,e,t,r=[],c=function(){fse.copySync(path.resolve(__dirname,"../examples/configs.json"),defaultConfigFilePath,{overwrite:!1})},i=function(o){n=o},s=function(){a(),w()},a=function(){clear(),l(),u(),f(),m()},l=function(){var n=g("myterminal-cli v"+version);console.log(chalk.inverse.cyan(k(" "))),console.log(chalk.inverse.cyan(n)),console.log(chalk.inverse.cyan(k(" "))+"\n")},u=function(){var o=r.map(function(n,o){return r.slice(0,o+1)}).map(function(o,e){return o.reduce(function(n,o){return n.commands[o]},n)}).map(function(n){return n.title});console.log(chalk.cyan([n.title].concat(o).join(" -> ")+"\n"))},f=function(){console.log("Press a marked key to perform the respective operation\n")},m=function(){var t=y();q().forEach(function(n){console.log(chalk.green("("+n+") ")+t.commands[n].title+(t.commands[n].commands?"...":""))}),h(),console.log(chalk.green("(/) ")+"Run a custom command"),e&&console.log(chalk.green("(.) ")+"Re-run the last command"),o&&console.log(chalk.green("[space] ")+"Select the last action"),t!==n?console.log(chalk.red("\n(q) ")+"Go back...\n"):console.log(chalk.red("\n(q) ")+"Quit\n")},d=function(n){console.log(chalk.inverse.green(g("Command: "+(n.title||n.task)))),console.log(chalk.inverse.white(g("Directory: "+R(n.directory)))),h()},p=function(){console.log("You can press ^-C to abort current task\n")},h=function(){console.log("")},g=function(n){var o=k(" ").length-n.length;return v(" ",Math.floor(o/2))+n+v(" ",Math.ceil(o/2))},k=function(n){return new Array(process.stdout.columns-1).join(",").split(",").map(function(){return n}).join("")},v=function(n,o){return new Array(o).join(",").split(",").map(function(){return n}).join("")},y=function(){return r.length?r.reduce(function(n,o){return n.commands[o]},n):n},q=function(){return Object.keys(y().commands)},j=function(o){return r.length?r.reduce(function(n,o){return n.commands[o]},n).commands[o]:n.commands[o]},w=function(){P(),stdin.on("data",A)},x=function(){stdin.removeListener("data",A)},C=function(){P(),stdin.on("data",I)},F=function(){stdin.removeListener("data",I)},P=function(){stdin.setRawMode(!0),stdin.resume(),stdin.setEncoding("utf8")},b=function(){process.on("SIGINT",function(){t?G():process.exit()})},A=function(n){if(x(),""===n)N();else if("/"===n)a(),p(),_();else if(" "===n)o?(a(),p(),S(o)):s();else if("."===n)e?(a(),p(),d(e),E(e.task,e.directory)):s();else if("q"===n)r.length||N(),r.pop(),s();else if(q().indexOf(n)>-1){var t=j(n),c=t.task;c?(a(),p(),S(t)):(r.push(n),s())}else s()},I=function(n){""===n&&G()},M=function(n){prompt.start(),prompt.get(n.params,function(o,e){try{var t=[n.task].concat(n.params.map(function(o,t){return e[n.params[t]]})).join(" ");E(t,n.directory)}catch(n){s()}})},R=function(n){return n||y().directory||"."},S=function(n){o=n,d(n),n.params?M(n):E(n.task,n.directory)},_=function(){prompt.start(),prompt.get(["custom-command","directory"],function(n,o){try{var e=R(o.directory);h(),S({title:o["custom-command"],task:o["custom-command"],directory:e})}catch(n){s()}})},E=function(n,o){var r=n.split(" "),c=r[0],i=r.slice(1),s=R(o);e={task:n,directory:s},t=spawn(c,i,{cwd:s,stdio:[0,1,2],shell:!0}),t.on("close",L),C()},G=function(){t.kill(),t=null},L=function(){console.log("\n"+chalk.green(k("-"))),t=null,F(),w()},N=function(){clear(),process.exit()};return b(),{copyConfigFileIfNotPresent:c,setConfigs:i,promptForAction:s}}();