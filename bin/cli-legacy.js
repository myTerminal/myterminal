"use strict";var os=require("os"),spawn=require("child_process").spawn,stdin=process.stdin,prompt=require("prompt"),chalk=require("chalk"),clear=require("clear"),version=require("../package.json").version;module.exports=function(){var n,o,e,t,c=[],r=function(){i(),y()},i=function(){clear(),s(),a(),l(),u()},s=function(){var n=p("myterminal-cli v"+version);console.log(chalk.inverse.cyan(g(" "))),console.log(chalk.inverse.cyan(n)),console.log(chalk.inverse.cyan(g(" "))+"\n")},a=function(){var o=c.map(function(n,o){return c.slice(0,o+1)}).map(function(o,e){return o.reduce(function(n,o){return n.commands[o]},n)}).map(function(n){return n.title});console.log(chalk.cyan([n.title].concat(o).join(" -> ")+"\n"))},l=function(){console.log("Press a marked key to perform the respective operation\n")},u=function(){var t=k();v().forEach(function(n){return console.log(chalk.green("("+n+") ")+t.commands[n].title+(t.commands[n].commands?"...":""))}),d(),o&&console.log(chalk.green("(;) ")+"Select the last action"),e&&console.log(chalk.green("(.) ")+"Re-run the last command"),console.log(chalk.green("(/) ")+"Run a custom command"),t!==n?console.log(chalk.red("\n(q) ")+"Go back...\n"):console.log(chalk.red("\n(q) ")+"Quit\n")},m=function(n){console.log(chalk.inverse.green(p("Command: "+(n.title||n.task)))),console.log(chalk.inverse.white(p("Directory: "+b(n.directory)))),d()},f=function(){console.log("You can press ^-C to abort current task\n")},d=function(){console.log("")},p=function(n){var o=g(" ").length-n.length;return h(" ",Math.floor(o/2))+n+h(" ",Math.ceil(o/2))},g=function(n){return new Array(process.stdout.columns-1).join(",").split(",").map(function(){return n}).join("")},h=function(n,o){return new Array(o).join(",").split(",").map(function(){return n}).join("")},k=function(){return c.length?c.reduce(function(n,o){return n.commands[o]},n):n},v=function(){return Object.keys(k().commands)},y=function(){q(),stdin.on("data",w)},q=function(){stdin.setRawMode(!0),stdin.resume(),stdin.setEncoding("utf8")},j=function(){process.on("SIGINT",function(){t?A():process.exit()})},w=function(t){if(stdin.removeListener("data",w),""===t)G();else if("/"===t)i(),f(),M();else if(";"===t)o?(i(),f(),C(o)):r();else if("."===t)e?(i(),f(),m(e),R(e.task,e.directory)):r();else if("q"===t)c.length||G(),c.pop(),r();else if(v().indexOf(t)>-1){var s=function(o){return c.length?c.reduce(function(n,o){return n.commands[o]},n).commands[o]:n.commands[o]}(t);s.task?(i(),f(),C(s)):(c.push(t),r())}else r()},x=function(n){""===n&&A()},b=function(n){return n||k().directory||"."},C=function(n){o=n,m(n),n.params?function(n){prompt.start(),prompt.get(n.params,function(o,e){try{var t=[n.task].concat(n.params.map(function(o,t){return e[n.params[t]]})).join(" ");R(t,n.directory)}catch(n){r()}})}(n):R(n.task,n.directory)},M=function(){prompt.start(),prompt.get(["custom-command","directory"],function(n,o){try{var e=b(o.directory);d(),C({title:o["custom-command"],task:o["custom-command"],directory:e})}catch(n){r()}})},R=function(n,o){var c=n.split(" "),r=c[0],i=c.slice(1),s=b(o);e={task:n,directory:s},(t=spawn(r,i,{cwd:s,stdio:[0,1,2],shell:!0})).on("close",E),q(),stdin.on("data",x)},A=function(){t.kill(),t=null},E=function(){console.log("\n"+chalk.green(g("-"))),t=null,stdin.removeListener("data",x),y()},G=function(){clear(),process.exit()};return{setConfigs:function(o){n=o},init:function(){j(),r()}}}();