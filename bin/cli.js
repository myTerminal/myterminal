"use strict";var _require=require("child_process"),spawn=_require.spawn,packageDetails=require("../package.json"),_require2=require("./interface"),drawControls=_require2.drawControls,_require3=require("./interface-actions"),updateThreaderText=_require3.updateThreaderText,updateMenuOptions=_require3.updateMenuOptions,printCommandLogHeader=_require3.printCommandLogHeader,printCommandLogFooter=_require3.printCommandLogFooter,bindCommandLog=_require3.bindCommandLog,exit=_require3.exit,configs=void 0,mostRecentlyRunCommand=void 0,lastRunShellCommand=void 0,currentCommandInstance=void 0,uiControls={},specialKeys=[";",".","/","q","C-c","C-q"],currentState=[],bindEventForAbortingCurrentCommandOnWindows=function(){process.on("SIGINT",function(){currentCommandInstance?abortCurrentShellCommand():process.exit()})},getCurrentCommandBranch=function(){return currentState.length?currentState.reduce(function(n,e){return n.commands[e]},configs):configs},getCurrentCommandOptions=function(){return Object.keys(getCurrentCommandBranch().commands)},rePrintMenu=function(){updateThreaderText(uiControls,currentState,configs),updateMenuOptions(uiControls,getCurrentCommandBranch(),getCurrentCommandOptions(),mostRecentlyRunCommand,lastRunShellCommand,configs),uiControls.screen.render()},unbindKeyStrokesToNavigate=function(){getCurrentCommandOptions().concat(specialKeys).forEach(function(n){return uiControls.screen.unkey(n)})},printCommandAbortInstructions=function(){uiControls.menuBoxTable.insertBottom("\nYou can press {yellow-fg}(\\){/} to abort current task")},promptForAction=function(){rePrintMenu(),bindKeyStrokesToNavigate()},promptUserForParametersAndExecuteCommand=function t(o,r,i){o.length===r.length?i(o):uiControls.prompt.input(r[o.length],"",function(n,e){try{t(o.concat([e]),r,i)}catch(n){uiControls.commandLogBox.insertBottom("{red-bg}"+n.toString()+"{/}"),uiControls.commandLogBox.setScrollPerc(100),promptForAction()}})},getSpecificCommandDirectory=function(n){return n||getCurrentCommandBranch().directory||"."},unbindKeyStrokesToQuitCurrentCommand=function(){uiControls.screen.unkey("\\")},finishUpWithCurrentCommand=function(){printCommandLogFooter(uiControls),rePrintMenu(),currentCommandInstance=null,unbindKeyStrokesToQuitCurrentCommand(),bindKeyStrokesToNavigate()},abortCurrentShellCommand=function(){currentCommandInstance.kill(),currentCommandInstance=null},keyStrokeHandlerForQuittingCurrentCommand=function(){uiControls.commandLogBox.insertBottom("{magenta-bg}Aborted{/}"),uiControls.commandLogBox.setScrollPerc(100),abortCurrentShellCommand()},bindKeyStrokesToQuitCurrentCommand=function(){uiControls.screen.key("\\",keyStrokeHandlerForQuittingCurrentCommand)},executeShellCommand=function(n,e){var t=n.split(" "),o=getSpecificCommandDirectory(e);lastRunShellCommand={task:n,directory:o},currentCommandInstance=spawn(t[0],t.slice(1),{cwd:o,shell:!0}),bindCommandLog(uiControls,currentCommandInstance),currentCommandInstance.on("close",finishUpWithCurrentCommand),bindKeyStrokesToQuitCurrentCommand()},gatherParamsAndExecuteCommand=function(n){var e=n.task,t=n.params,o=n.directory;promptUserForParametersAndExecuteCommand([],t,function(n){executeShellCommand([e].concat(n).join(" "),o)})},prepareToExecuteCommandObject=function(n){mostRecentlyRunCommand=n,uiControls.menuBox.width="50%",uiControls.commandLogBox.show(),printCommandLogHeader(uiControls,n,getSpecificCommandDirectory(n.directory)),n.params?gatherParamsAndExecuteCommand(n):executeShellCommand(n.task,n.directory)},promptForCustomCommandAndExecute=function(){promptUserForParametersAndExecuteCommand([],["custom-command","directory"],function(n){prepareToExecuteCommandObject({title:n[0],task:n[0],directory:getSpecificCommandDirectory(n[1])})})},getCommandForOption=function(n){return currentState.length?currentState.reduce(function(n,e){return n.commands[e]},configs).commands[n]:configs.commands[n]},keyStrokeHandlerForNavigation=function(n){if(unbindKeyStrokesToNavigate(),"C-c"===n||"C-q"===n)exit(uiControls);else if("/"===n)rePrintMenu(),printCommandAbortInstructions(),promptForCustomCommandAndExecute();else if(";"===n)mostRecentlyRunCommand?(rePrintMenu(),printCommandAbortInstructions(),prepareToExecuteCommandObject(mostRecentlyRunCommand)):promptForAction();else if("."===n)lastRunShellCommand?(rePrintMenu(),printCommandAbortInstructions(),printCommandLogHeader(uiControls,lastRunShellCommand,getSpecificCommandDirectory(lastRunShellCommand.directory)),executeShellCommand(lastRunShellCommand.task,lastRunShellCommand.directory)):promptForAction();else if("q"===n)currentState.length||exit(uiControls),currentState.pop(),promptForAction();else if(-1<getCurrentCommandOptions().indexOf(n)){var e=getCommandForOption(n);e.task?(rePrintMenu(),printCommandAbortInstructions(),prepareToExecuteCommandObject(e)):(currentState.push(n),promptForAction())}else promptForAction()},bindKeyStrokesToNavigate=function(){getCurrentCommandOptions().concat(specialKeys).forEach(function(n){return uiControls.screen.key(n,keyStrokeHandlerForNavigation)})};module.exports.start=function(n){configs=n,bindEventForAbortingCurrentCommandOnWindows(),(uiControls=drawControls(packageDetails)).screen.enableKeys(),promptForAction()};